# TabMagnet 标签分组修复测试指南

## 修复内容

本次修复解决了用户反馈的"重启浏览器后，所有的分组都会失效"和"所有tab都自动放入了同一个分组"的问题。

### 主要改进

1. **保守的标签处理策略**
   - 移除了过度的分组管理逻辑
   - 采用"不破坏现有分组"的保守策略
   - 只在必要时移动标签

2. **智能标签过滤**
   - 新增 `shouldSkipTabProcessing()` 函数
   - 跳过处理恢复的标签、系统标签和扩展页面
   - 避免在浏览器启动时干扰标签恢复

3. **修复"最右侧打开"功能**
   - 即使选择"end"位置，也会主动移动标签到最右侧
   - 确保行为一致性

4. **改进的错误处理**
   - 添加延迟等待Chrome完成标签设置
   - 重新获取标签信息确保状态准确
   - 更好的异常处理和日志记录

### 工作原理

#### 标签过滤机制
- **跳过恢复的标签**: 有URL但没有opener的标签被认为是恢复的标签
- **跳过系统标签**: chrome://页面（除了新标签页）
- **跳过扩展页面**: chrome-extension://页面
- **跳过固定标签**: 通常是重要的系统标签

#### 标签移动逻辑
- **简单移动**: 使用Chrome原生的tabs.move()API
- **尊重分组**: 让Chrome自己处理分组边界
- **延迟处理**: 等待50ms让Chrome完成初始设置
- **重新获取**: 移动前重新获取标签状态

## 测试步骤

### 测试1: 基本分组保持功能
1. 创建一个标签分组，包含2-3个标签
2. 在分组中的标签上右键 → "在新标签页中打开链接"
3. 验证新标签是否正确放置且分组保持完整

### 测试2: 分组边界处理
1. 创建一个标签分组
2. 选择分组中的第一个标签，设置插件为"右侧打开"
3. 从该标签打开新标签，验证新标签是否加入分组
4. 选择分组中的中间标签，重复测试，验证新标签是否在分组外

### 测试3: 最右侧打开修复
1. 设置插件为"最右侧打开"
2. 打开新标签，验证是否确实在最右侧
3. 重启浏览器，验证分组是否保持

### 测试4: 跨窗口处理
1. 打开多个浏览器窗口
2. 在不同窗口中测试标签创建
3. 验证分组信息是否正确处理

## 预期结果

- ✅ 标签分组在重启浏览器后保持完整
- ✅ 新标签正确放置在指定位置
- ✅ 不会将所有标签放入同一个分组
- ✅ "最右侧打开"功能正常工作
- ✅ 不会干扰浏览器的标签恢复过程
- ✅ 不会处理系统标签和扩展页面

## 回退方案

如果出现问题，可以：
1. 恢复 `background.js` 中的原始简单逻辑
2. 移除标签过滤机制
3. 回退到版本 1.0.4
